{% extends 'layout/base.html' %}
{% load static poll_extras %}
{% block content %}
    <div class="ms-content-wrapper">
        <div class="ms-profile-overview">
            <div class="ms-profile-cover">
                <img class="ms-profile-img" src="{{ patient.image }}" alt="people">
                <div class="ms-profile-user-info">
                    <h3 class="ms-profile-username text-white">{{ patient.fullname }}</h3>
                </div>
                <div class="ms-profile-user-buttons">
                    <a href="{{ patient.image }}" target="_blank" class="btn btn-primary"> <i class="material-icons">file_download</i>
                        Скачать отчёт</a>
                    <a href="{{ patient.image }}" target="_blank" class="btn btn-success"> <i class="fas fa-pencil-alt"></i>
                        Записать на приём</a>
                </div>

            </div>
        </div>
        <div class="row">
            <div class="col-xl-7 col-md-12">
                <div class="ms-panel">
                    <div class="ms-panel-header ms-panel-custome">
                        <h6>Список заявок пациента</h6>
                        <a href="#order_modal" data-toggle="modal" class="ms-text-primary">Добавить заявку</a>
                    </div>
                    <div class="ms-panel-body">
                        <div class="table-responsive">
                            <table id="my_data_table" class="table table-striped thead-primary w-100">
                                <thead>
                                <tr role="row">
                                    <th tabindex="0" aria-controls="example" rowspan="1"
                                        colspan="1"
                                        aria-label="Office: activate to sort column ascending"
                                    >#
                                    </th>
                                    <th tabindex="0" aria-controls="example" rowspan="1"
                                        colspan="1"
                                        aria-label="Office: activate to sort column ascending"
                                    >Дата визита
                                    </th>
                                    <th tabindex="0" aria-controls="example" rowspan="1"
                                        colspan="1"
                                        aria-label="Office: activate to sort column ascending"
                                    >Доктор
                                    </th>
                                    <th tabindex="0" aria-controls="example" rowspan="1"
                                        colspan="1"
                                        aria-label="Office: activate to sort column ascending"
                                    >Зарегистрировал
                                    </th>
                                    <th tabindex="0" aria-controls="example" rowspan="1"
                                        colspan="1"
                                        aria-label="Office: activate to sort column ascending"
                                    >Статус
                                    </th>
                                    <th tabindex="0" aria-controls="example" rowspan="1"
                                        colspan="1"
                                        aria-label="Office: activate to sort column ascending"
                                    >Действия
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for order in orders %}
                                    <tr role="row">
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ order.created }}</td>
                                        <td>{{ order.doctor }}</td>
                                        <td>{{ order.registrar }}</td>
                                        <td>{{ order.get_status_display }}</td>
                                        <td>
                                            <a href="{% url 'order_detail' order.pk %}"><i
                                                    class="text-success fa fa-eye"></i></a>
                                            <a href="{% url 'order_update' order.pk %}?back_url=patient_detail&back_pk={{ order.patient_id }}"><i
                                                    class="text-primary fa fa-pencil-alt"></i></a>
                                            <a onclick="return confirm('Вы дейсвительно хотите удалить?')"
                                               href="{% url 'order_action' %}"><i
                                                    class="text-danger fa fa-trash-alt"></i></a></td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-5 col-md-12">
                <div class="ms-panel ms-panel-fh">
                    <div class="ms-panel-body">
                        <h2 class="section-title">Информация о пациенте</h2>
                        <table class="table ms-profile-information">
                            <tbody>
                            <tr>
                                <th scope="row">Ф.И.О</th>
                                <td>{{ patient.fullname }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Дата рождения</th>
                                <td>{{ patient.birthday }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Дата последнего визита стоматолога</th>
                                <td>{{ patient.last_visit|default:'Не задано' }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Номер телефона</th>
                                <td>{{ patient.phone }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Адрес</th>
                                <td>{{ patient.address }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Тип документа</th>
                                <td>{{ patient.get_doc_type_display }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Серия документа</th>
                                <td>{{ patient.doc_series }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Номер документа</th>
                                <td>{{ patient.doc_number }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Статус</th>
                                <td>{{ patient.get_status_display }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Зарегистрировал</th>
                                <td>{{ patient.registrar }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Дата регистрации</th>
                                <td>{{ patient.created }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Дата последнего визита</th>
                                <td>{{ last_order.created|default:patient.updated }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="order_modal" role="dialog" aria-hidden="true">
    <div class="modal-dialog ms-modal-dialog-width">
        <div class="modal-content ms-modal-content-width">
            <div class="modal-header  ms-modal-header-radius-0">
                <h4 class="modal-title text-white">Создать заявку для пациента: {{ patient.fullname }}</h4>
                <button type="button" class="close  text-white" data-dismiss="modal" aria-hidden="true">x</button>

            </div>
            <div class="modal-body p-0 text-left">
                <div class="col-xl-12 col-md-12">
                    <div class="ms-panel ms-panel-bshadow-none">
                        <div class="ms-panel-header">
                            <h6>Детали заявки</h6>
                        </div>
                        <div class="ms-panel-body">
                            <form class="needs-validation" novalidate="" action="{% url 'order_action' %}"
                                  method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="create_order_for_patient">
                                <input type="hidden" name="patient_id" value="{{ patient.pk }}">
                                <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom10">Доктор</label>
                                        <div class="input-group">
                                            <select class="form-control" style="width: 100%" name="doctor" id="select_doctor">
                                                {% for doctor in doctors %}
                                                    <option value="{{ doctor.pk }}">{{ doctor.fullname }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-2">
                                        <label for="validationCustom11">Диагноз</label>
                                        <div class="input-group">
                                            <textarea class="form-control" name="content" id="" cols="30" rows="10">
                                            </textarea>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-warning float-right my-4" type="submit">Сохранить</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
    <script>
        $(document).ready(function () {
            $('#my_data_table').DataTable()
        });
    </script>
{% endblock extra_js %}